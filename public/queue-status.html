<!DOCTYPE html>
<html>
<head>
    <title>Queue Status - CryptoShowClub</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #7f00ff, #e100ff);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .search-box input {
            width: 70%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-right: 10px;
        }

        .search-box button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #7f00ff, #e100ff);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: opacity 0.3s;
        }

        .search-box button:hover {
            opacity: 0.9;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .status-card h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.5em;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .tier-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .tier-stat {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .tier-stat.premium {
            background: linear-gradient(135deg, #7f00ff20, #e100ff20);
        }

        .tier-stat.standard {
            background: linear-gradient(135deg, #00b4db20, #0083b020);
        }

        .tier-stat.free {
            background: linear-gradient(135deg, #56ab2f20, #a8e06320);
        }

        .tier-stat h3 {
            margin: 0;
            font-size: 1.2em;
            color: #666;
        }

        .tier-stat .count {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .tier-stat .wait-time {
            font-size: 0.9em;
            color: #666;
        }

        .position-info {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .position-info.visible {
            display: block;
        }

        .position-info h2 {
            color: #333;
            margin-top: 0;
        }

        .position-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .detail-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .detail-card h3 {
            margin: 0;
            color: #666;
            font-size: 1.1em;
        }

        .detail-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .error-message {
            display: none;
            color: #dc3545;
            background: #dc354520;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
        }

        .notification-preferences {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .notification-preferences h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.3em;
        }

        .email-input {
            margin-bottom: 20px;
        }

        .email-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .preference-option {
            display: flex;
            flex-direction: column;
            padding: 15px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .preference-option:hover {
            transform: translateY(-2px);
        }

        .preference-option input[type="checkbox"] {
            margin-bottom: 10px;
        }

        .preference-option span {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .preference-option small {
            color: #666;
            font-size: 0.9em;
        }

        .save-preferences {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #7f00ff, #e100ff);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .save-preferences:hover {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .search-box input {
                width: 100%;
                margin-bottom: 10px;
            }

            .search-box button {
                width: 100%;
            }

            .tier-stats {
                grid-template-columns: 1fr;
            }

            .preferences-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Queue Status</h1>
    </div>

    <div class="container">
        <div class="search-box">
            <input type="text" id="tokenAddress" placeholder="Enter your token address">
            <button onclick="checkPosition()">Check Position</button>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h2>Current Queue Status</h2>
                <div id="queueStats" class="tier-stats">
                    <div class="tier-stat premium">
                        <h3>Premium</h3>
                        <div class="count">-</div>
                        <div class="wait-time">Avg. Wait: -</div>
                    </div>
                    <div class="tier-stat standard">
                        <h3>Standard</h3>
                        <div class="count">-</div>
                        <div class="wait-time">Avg. Wait: -</div>
                    </div>
                    <div class="tier-stat free">
                        <h3>Free</h3>
                        <div class="count">-</div>
                        <div class="wait-time">Avg. Wait: -</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="positionInfo" class="position-info">
            <h2>Your Position</h2>
            <div class="position-details">
                <div class="detail-card">
                    <h3>Queue Position</h3>
                    <div class="value" id="queuePosition">-</div>
                </div>
                <div class="detail-card">
                    <h3>Tokens Ahead</h3>
                    <div class="value" id="tokensAhead">-</div>
                </div>
                <div class="detail-card">
                    <h3>Estimated Showcase</h3>
                    <div class="value" id="estimatedTime">-</div>
                </div>
            </div>

            <!-- Add notification preferences section -->
            <div class="notification-preferences">
                <h3>Notification Preferences</h3>
                <div class="email-input">
                    <input type="email" id="notificationEmail" placeholder="Enter your email">
                </div>
                <div class="preferences-grid">
                    <label class="preference-option">
                        <input type="checkbox" id="notifyPositionChange" checked>
                        <span>Position Changes</span>
                        <small>Get notified when your position changes significantly</small>
                    </label>
                    <label class="preference-option">
                        <input type="checkbox" id="notifyBeforeShowcase" checked>
                        <span>Showcase Warning</span>
                        <small>Get notified 30 minutes before your showcase time</small>
                    </label>
                    <label class="preference-option">
                        <input type="checkbox" id="notifyOnTurn" checked>
                        <span>Showcase Ready</span>
                        <small>Get notified when it's your turn to be showcased</small>
                    </label>
                </div>
                <button onclick="saveNotificationPreferences()" class="save-preferences">Save Preferences</button>
            </div>
        </div>

        <div id="errorMessage" class="error-message"></div>
    </div>

    <script>
        // Load queue stats on page load
        document.addEventListener('DOMContentLoaded', loadQueueStats);

        async function loadQueueStats() {
            try {
                const response = await fetch('http://localhost:3000/api/queue/stats');
                const result = await response.json();

                if (result.success) {
                    updateQueueStats(result.data);
                }
            } catch (error) {
                console.error('Error loading queue stats:', error);
            }
        }

        function updateQueueStats(stats) {
            const tiers = ['premium', 'standard', 'free'];
            tiers.forEach(tier => {
                const count = stats.byTier[tier];
                const waitTime = stats.averageWaitTime[tier];
                
                const tierElement = document.querySelector(`.tier-stat.${tier}`);
                tierElement.querySelector('.count').textContent = count;
                tierElement.querySelector('.wait-time').textContent = 
                    `Avg. Wait: ${Math.round(waitTime)}h`;
            });
        }

        async function checkPosition() {
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            const positionInfo = document.getElementById('positionInfo');
            const errorMessage = document.getElementById('errorMessage');

            if (!tokenAddress) {
                showError('Please enter a token address');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/queue/position/${tokenAddress}`);
                const result = await response.json();

                if (result.success) {
                    updatePositionInfo(result.data);
                    positionInfo.classList.add('visible');
                    errorMessage.style.display = 'none';
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('Error checking position:', error);
                showError('Failed to check position. Please try again.');
            }
        }

        function updatePositionInfo(data) {
            document.getElementById('queuePosition').textContent = data.position;
            
            const totalAhead = Object.values(data.totalAhead).reduce((a, b) => a + b, 0);
            document.getElementById('tokensAhead').textContent = totalAhead;
            
            const estimatedTime = new Date(data.estimatedShowcaseTime);
            document.getElementById('estimatedTime').textContent = 
                estimatedTime.toLocaleDateString() + ' ' + 
                estimatedTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            document.getElementById('positionInfo').classList.remove('visible');
        }

        async function saveNotificationPreferences() {
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            const email = document.getElementById('notificationEmail').value.trim();
            
            if (!tokenAddress) {
                showError('Please enter a token address');
                return;
            }
            
            if (!email) {
                showError('Please enter an email address');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/notifications/preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tokenAddress,
                        email,
                        notifyOnPositionChange: document.getElementById('notifyPositionChange').checked,
                        notifyBeforeShowcase: document.getElementById('notifyBeforeShowcase').checked,
                        notifyOnTurn: document.getElementById('notifyOnTurn').checked
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess('Notification preferences saved successfully!');
                } else {
                    showError(result.message || 'Failed to save preferences');
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                showError('Failed to save preferences. Please try again.');
            }
        }

        function showSuccess(message) {
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.textContent = message;
            document.getElementById('positionInfo').appendChild(successMessage);
            setTimeout(() => successMessage.remove(), 3000);
        }

        // Load existing preferences when checking position
        async function loadNotificationPreferences(tokenAddress) {
            try {
                const response = await fetch(`http://localhost:3000/api/notifications/preferences/${tokenAddress}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    document.getElementById('notificationEmail').value = result.data.email;
                    document.getElementById('notifyPositionChange').checked = result.data.notifyOnPositionChange;
                    document.getElementById('notifyBeforeShowcase').checked = result.data.notifyBeforeShowcase;
                    document.getElementById('notifyOnTurn').checked = result.data.notifyOnTurn;
                }
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        }

        // Update checkPosition function to also load preferences
        const originalCheckPosition = checkPosition;
        checkPosition = async function() {
            await originalCheckPosition();
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            if (tokenAddress) {
                await loadNotificationPreferences(tokenAddress);
            }
        };
    </script>
</body>
</html> 